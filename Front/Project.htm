<!DOCTYPE html>
<html lang="zh-hant" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¡ˆ</title>

    <!-- Sweet alert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Bootstarp5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- CSS & Js -->
    <link href="css/style.css" rel="stylesheet">
    <script src="js/function.js"></script>
    <script src="js/webapi.js"></script>
    <script src="js/element.js"></script>

</head>
<script>
    // ä½¿ç”¨è€…æŒ‰ä¸‹ Project é¸é …å¾Œï¼Œç´€éŒ„è©²é¸é …çš„ ProjectID
    let clickedProjID = null;
    // å®šç¾©åœ–è¡¨ç‰©ä»¶è³‡æ–™
    let chartInfo = null;

    // åˆå§‹åŒ–å‹•ä½œ
    window.onload = function () {
        // å®šç¾©æ©Ÿå™¨é™£åˆ—æ¸…å–®
        let machinelist = null;
        // å®šç¾©å°ˆæ¡ˆé™£åˆ—æ¸…å–®ï¼Œæœ€å¾Œæœƒæ”¾å…¥å·¦é‚Šçš„æ¸…å–®åˆ—ä¸­
        let projectContainer = document.getElementById('projectContainer'); // project åˆ—è¡¨çš„å…ƒä»¶
        InitializeProcess();
    }

    async function InitializeProcess() {
        // åˆå§‹åŒ–ä½ çš„ç€è¦½å™¨é¡è‰²
        setColorMode();

        // åˆå§‹åŒ–åœ–è¡¨ç‰©ä»¶
        chartInfo = Initialize_ChartInfo('Chart');
        chartInfo.Chart.options.animation.duration = 500;
        await GetMachineList();
        await GetProjectList();
    }
    // æŠ“å– Machine è³‡æ–™
    async function GetMachineList() {

        // å‘¼å« WebAPI å–å¾— Machine è³‡æ–™è¡¨çš„æ‰€æœ‰è³‡æ–™
        machinelist = await API_GetMachineList();

        // å–å¾—ä¸Šå‚³ CSV æª”æ¡ˆå°é é¢ä¸­ï¼Œæ©Ÿå°ä¸‹æ‹‰å¼é¸å–®çš„å…ƒä»¶
        let selectCSVMachineID = document.getElementById('selectCSVMachineID');

        // ä¸€é–‹å§‹å…ˆæŠŠä¸‹æ‹‰å¼åˆ—è¡¨çš„é¸é …éƒ½å…ˆåˆªé™¤ã€‚
        selectCSVMachineID.options.length = 0;

        // ç”¨è¿´åœˆæŠŠ Machine çš„æ‰€æœ‰è³‡æ–™æ·»åŠ è‡³æ©Ÿå°çš„ä¸‹æ‹‰å¼é¸å–®ä¸­
        machinelist.forEach(element => {
            // å…ˆå‰µå»ºä¸€å€‹ option çš„å…ƒä»¶ã€‚
            let option = document.createElement('option');
            // çµ¦äºˆé€™å€‹ option é¡¯ç¤ºå‡ºä¾†çš„æ–‡å­—è·Ÿé€™å€‹ option çš„å€¼ã€‚
            option.text = element.name;
            option.value = element.id;
            // æŠŠè©²é¸é …æ·»åŠ è‡³æ©Ÿå°çš„ä¸‹æ‹‰å¼é¸å–®ä¸­ã€‚
            selectCSVMachineID.add(option);
        });
    }

    // å°‡é¸å®šçš„æ”¾å…¥å·¦é‚Šçš„"å°ˆæ¡ˆæ¸…å–®"ä¸­
    async function GetProjectList() {

        // ä¸€é–‹å§‹å…ˆæŠŠ project åˆ—è¡¨çš„é¸é …éƒ½å…ˆåˆªé™¤ã€‚
        projectContainer.options.length = 0;

        // ç”¨ WebAPI å»å‘¼å« Project è³‡æ–™è¡¨è£¡é¢çš„è³‡æ–™ã€‚
        const projectlist = await API_GetProjectList();

        // ç”¨è¿´åœˆæŠŠ Project List çš„è³‡æ–™æ·»åŠ åˆ° Project åˆ—è¡¨çš„é¸é …ä¸­ã€‚
        projectlist.forEach(element => {
            // å…ˆå‰µå»ºä¸€å€‹ Option çš„å…ƒä»¶ã€‚
            let option = document.createElement('option');
            // åˆ©ç”¨ Machine ID å»å°‹æ‰¾ Machine list ä¸­å°æ‡‰çš„ Machine Nameã€‚
            const machinename = machinelist.find(c => c.id === element.machineID)?.name;

            // çµ¦äºˆé€™å€‹ Option é¡¯ç¤ºå‡ºä¾†çš„æ–‡å­—è·Ÿé€™å€‹ Option çš„å€¼ã€‚
            option.text = `ã€${element.id}ã€‘${machinename} `;
            option.value = JSON.stringify(element);

            // æŠŠè©² Option æ·»åŠ è‡³å°ˆæ¡ˆåˆ—è¡¨çš„é¸é …å…ƒä»¶ä¸­ã€‚
            projectContainer.add(option);
        });

        // ç•¶å°ˆæ¡ˆåˆ—è¡¨çš„é¸é …è¢«æŒ‰ä¸‹ï¼Œè¦é¡¯ç¤ºè©²é¸é …çš„ç›¸é—œè³‡è¨Šã€‚
        projectContainer.addEventListener('change', async (e) => {

            // å–å¾—è¢«ä½¿ç”¨è€…é»ä¸‹çš„é‚£å€‹é¸é …ä¸­ï¼Œè£¡é¢çš„å€¼ã€‚
            const proj = JSON.parse(e.target.value);

            // é¡¯ç¤ºè©²é¸é …ä¸­çš„ project è³‡è¨Šåˆ° å°ˆæ¡ˆè³‡è¨Šå¡ç‰‡ä¸­ã€‚
            clickedProjID = proj.id; // ç´€éŒ„ä½¿ç”¨è€…é»äº†å“ªå€‹ Project IDã€‚
            document.getElementById('txtProjectID').value = proj.id;
            document.getElementById('txtMachineName').value = machinelist.find(c => c.id === proj.machineID)?.name;
            document.getElementById('txtRecordTime').value = proj.recordDateTime;

            // æ ¹æ“šä½¿ç”¨è€…é»é¸çš„ project ID ï¼Œç”¨ WebAPI å»è¦å±¬æ–¼é€™å€‹ project ID çš„è³‡æ–™ã€‚
            const featuredata = await API_GetData(proj.id);

            // æ¸…ç©º Chart ä¸Šé¢åŸæœ¬çš„è³‡æ–™ã€‚
            chartInfo.Data.labels = []
            chartInfo.Data.datasets.forEach(element => {
                element.data = [];
            });

            // æŠŠè©² project ID çš„æ•¸å€¼å¯«é€²å» Chart è£¡é¢ã€‚
            let index = 0;
            featuredata.forEach(element => {

                index = index + 1; // è¨ˆæ•¸å™¨+1
                chartInfo.Data.labels.push(index); // Chart æ©«å‘æ”¾è¨ˆæ•¸å™¨ã€‚

                // æ·»åŠ ç›´å‘çš„è³‡æ–™
                chartInfo.Data.datasets[0].data.push(element.xRms);
                chartInfo.Data.datasets[1].data.push(element.yRms);
                chartInfo.Data.datasets[2].data.push(element.zRms);
            });

            // æ›´æ–°Chartåœ–è¡¨ã€‚
            chartInfo.Chart.update();
        });
    }

    // åˆªé™¤ project ã€‚
    async function btnDeleteProject() {

        // (æª¢æŸ¥) ä½¿ç”¨è€…æ²’æœ‰é»é¸å°ˆæ¡ˆåˆ—è¡¨è£¡é¢çš„é¸é …ã€‚
        if (clickedProjID == null) {
            Swal.fire({
                title: 'è­¦å‘Š',
                text: 'ä¸¦æ²’æœ‰é»é¸è¦åˆªé™¤çš„å°ˆæ¡ˆã€‚',
                icon: 'warning',
                confirmButtonText: 'OK'
            });
            return; // çµæŸå‹•ä½œã€‚
        }

        // (é›™é‡ç¢ºèª) ç¢ºå®šä½¿ç”¨è€…çœŸçš„è¦åˆªé™¤ã€‚
        const isCheck = await Swal.fire({
            title: 'åˆªé™¤å°ˆæ¡ˆ',
            text: `ä½ ç¢ºå®šè¦åˆªé™¤ project ID:[${clickedProjID}] å—ï¼Ÿ`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'åˆªé™¤',
            cancelButtonText: 'å–æ¶ˆ'
        });

        // ç•¶ä½¿ç”¨è€…æŒ‰ä¸‹ç¢ºå®šåˆªé™¤ï¼Œè¦åŸ·è¡Œåˆªé™¤å°ˆæ¡ˆçš„å‹•ä½œã€‚
        if (isCheck.isConfirmed) {
            await API_DeleteProject(clickedProjID);

            GetProjectList();

            // æ¸…ç©º Chart ä¸Šé¢åŸæœ¬çš„è³‡æ–™ã€‚
            chartInfo.Data.labels = []
            chartInfo.Data.datasets.forEach(element => {
                element.data = [];

                document.getElementById('txtProjectID').value = '';
                document.getElementById('txtMachineName').value = '';
                document.getElementById('txtRecordTime').value = '';

                // æ›´æ–°Chartåœ–è¡¨ã€‚
                chartInfo.Chart.update();

                Swal.fire({
                    title: 'æˆåŠŸï¼',
                    text: 'æˆåŠŸåˆªé™¤å°ˆæ¡ˆ',
                    icon: 'success',
                    confirmButtonText: 'ç¢ºå®š'
                });
                return; // çµæŸå‹•ä½œã€‚
            });
        }
    }
    async function btnUploadCSVFile() {
        const fileInput = document.getElementById('inputCSVFile');

        // å–å¾—é¸ä¸­çš„æª”æ¡ˆ (é€™æ˜¯ä¸€å€‹ FileList ç‰©ä»¶)
        const file = fileInput.files[0];  // å–å¾—ç¬¬ä¸€å€‹æª”æ¡ˆ (å¦‚æœæœ‰é¸æ“‡çš„è©±)

        // æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
        if (!file) {
            // æ²’æœ‰é¸æ“‡æª”æ¡ˆ
            Swal.fire({
                title: 'éŒ¯èª¤',
                text: 'è«‹é¸æ“‡ä¸€å€‹ CSV æª”æ¡ˆã€‚',
                icon: 'error',
                confirmButtonText: 'ç¢ºå®š'
            });
            return;
        }

        // æª¢æŸ¥æª”æ¡ˆæ ¼å¼æ˜¯å¦ç‚º .csv
        if (file.name.split('.').pop().toLowerCase() !== 'csv') {
            // å¦‚æœæª”æ¡ˆæ ¼å¼ä¸æ˜¯ CSV
            Swal.fire({
                title: 'éŒ¯èª¤',
                text: 'æª”æ¡ˆå¿…é ˆæ˜¯ CSV æ ¼å¼ã€‚',
                icon: 'error',
                confirmButtonText: 'ç¢ºå®š'
            });
            return;
        }

        // éƒ½æ²’å•é¡Œå°±ä¸Šå‚³æª”æ¡ˆ
        const MachineID = document.querySelector("#selectCSVMachineID").value;
        const isUpload = await API_UploadCSV(MachineID, file);

        // å¦‚æœæª”æ¡ˆä¸Šå‚³å¤±æ•—
        if (isUpload.error) {
            Swal.fire({
                title: 'éŒ¯èª¤',
                text: error.message,
                icon: 'error',
                confirmButtonText: 'ç¢ºå®š'
            });
            return;
        }

        GetProjectList();

        // æ¸…ç©º Chart ä¸Šé¢åŸæœ¬çš„è³‡æ–™ã€‚
        chartInfo.Data.labels = []
        chartInfo.Data.datasets.forEach(element => {
            element.data = [];
        });
        chartInfo.Chart.update();

        // é¡¯ç¤ºä¸Šå‚³æˆåŠŸ
        Swal.fire({
            title: 'æˆåŠŸ',
            text: 'ä¸Šå‚³æˆåŠŸ',
            icon: 'success',
            confirmButtonText: 'ç¢ºå®š'
        }).then((result) => {

            // é—œé–‰ä¸Šå‚³é é¢
            const btnCloseModal = document.getElementById('btnCloseCSVModal');
            btnCloseModal.click();
        });
    }

    function setColorMode() {
        const currentTheme = window.matchMedia("(prefers-color-scheme: dark)").matches;

        var htmlTag = document.documentElement;
        if (currentTheme) {
            // ç•¶ä½¿ç”¨è€…çš„åå¥½æ˜¯æš—è‰²æ¨¡å¼æ™‚
            htmlTag.setAttribute('data-bs-theme', 'dark');
            this.textContent = 'â˜€ï¸';  // ä½¿ç”¨æš—è‰²æ¨¡å¼æ™‚é¡¯ç¤º â˜€ï¸
        } else {
            // ç•¶ä½¿ç”¨è€…çš„åå¥½æ˜¯æ˜äº®æ¨¡å¼æ™‚
            htmlTag.setAttribute('data-bs-theme', 'light');
            this.textContent = 'ğŸŒ™';  // ä½¿ç”¨æ˜äº®æ¨¡å¼æ™‚é¡¯ç¤º ğŸŒ™
        }
    };

    //  ä½ˆæ™¯ä¸»é¡Œè½‰æ›
    document.addEventListener('DOMContentLoaded', function () {
        const themeToggleBtn = document.getElementById('theme-toggle-btn');

        // è¨­å®šåˆå§‹åœ–ç¤º
        themeToggleBtn.textContent = document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';

        themeToggleBtn.addEventListener('click', function (e) {
            e.preventDefault();

            const htmlTag = document.documentElement;
            const currentTheme = htmlTag.getAttribute('data-bs-theme');

            if (currentTheme === 'light') {
                htmlTag.setAttribute('data-bs-theme', 'dark');
                this.textContent = 'â˜€ï¸';
            } else {
                htmlTag.setAttribute('data-bs-theme', 'light');
                this.textContent = 'ğŸŒ™';
            }
        });
    });
</script>

<body>
    <!-- å°è¦½åˆ— -->
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
        <div class="container">
            <ul class="navbar-nav">
                <a class="nav-link" id="theme-toggle-btn" href="#"></a>
                <li class="nav-item">
                    <a class="nav-link" href="#">å·¥å» </a>
                <li class="nav-item">
                    <a class="nav-link" href="Mechine.htm">æ©Ÿå™¨</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="#">å°ˆæ¡ˆ</a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- å…§å®¹ -->
    <div class="container mt-5 content">
        <!-- æ¨™é¡Œ -->
        <h1>å°ˆæ¡ˆåˆ—è¡¨</h1><br>

        <!-- æŠŠå…§å®¹åˆ‡æˆå·¦å³å…©é‚Š -->
        <div class="row">

            <!-- (å·¦é‚Š) Project list -->
            <div class="col-lg-3">
                <div class="h-100 d-flex flex-column">
                    <label for="projectContainer" class="form-label">å°ˆæ¡ˆåˆ—è¡¨ï¼š</label>
                    <select class="form-select flex-grow-1" id="projectContainer" size="8"></select>
                </div>
            </div>
            <!-- (å³é‚Š) Projectçš„è³‡è¨Šã€Chartã€ä¸Šå‚³åˆªé™¤çš„æŒ‰éˆ• -->
            <div class="col-lg-9 d-flex flex-column">

                <!-- å°ˆæ¡ˆè³‡è¨Š -->
                <div class="card shadow-sm mb-4">

                    <!-- æ¨™é¡Œ -->
                    <div class="card-header bg-light text-primary">
                        <strong>å°ˆæ¡ˆè³‡è¨Š</strong>
                    </div>

                    <!-- å…§å®¹ -->
                    <div class="card-body">

                        <!-- åˆ†å‰²(å·¦é‚Šã€ä¸­é–“ã€å³é‚Š)ï¼Œæ¯å€‹ä¸­é–“æœƒæœ‰é–“éš”3 -->
                        <div class="row g-3">

                            <!-- Project ID -->
                            <div class="col-lg-4">

                                <!-- å°æ¨™é¡Œ -->
                                <label for="startDatePicker" class="form-label">å°ˆæ¡ˆ IDï¼š</label>
                                <input type="text" id="txtProjectID" class="form-control" disabled>
                            </div>

                            <!-- Machine Name -->
                            <div class="col-lg-4">
                                <!-- å°æ¨™é¡Œ -->
                                <label for="endDatePicker" class="form-label">æ©Ÿå™¨åç¨±ï¼š</label>
                                <input type="text" id="txtMachineName" class="form-control" disabled>
                            </div>

                            <!-- Record Time -->
                            <div class="col-lg-4">
                                <!-- å°æ¨™é¡Œ -->
                                <label for="endDatePicker" class="form-label">æ™‚é–“ï¼š</label>
                                <input type="text" id="txtRecordTime" class="form-control" disabled>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart (æŠ˜ç·šåœ–ã€é•·æ¢åœ–) -->
                <div class="card flex-grow-1 shadow-sm">
                    <div class="card-body">
                        <canvas id="Chart" class="w-100 h-100"></canvas>
                    </div>
                </div>

                <!-- æœ€ä¸‹é¢å…©å€‹æŒ‰éˆ• -->
                <div class="row">
                    <!-- åˆªé™¤å°ˆæ¡ˆçš„æŒ‰éˆ• -->
                    <div class="col-lg-6 d-grid mt-3">
                        <button type="button" class="btn btn-danger" onclick="btnDeleteProject()">åˆªé™¤å°ˆæ¡ˆ</button>
                    </div>
                    <!-- ä¸Šå‚³ CSV æª”æ¡ˆçš„æŒ‰éˆ• -->
                    <div class="col-lg-6 d-grid mt-3">
                        <button type="button" class="btn btn-success" data-bs-toggle="modal"
                            data-bs-target="#CSVModal">ä¸Šå‚³ CSV æª”æ¡ˆ</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ç•¶æŒ‰ä¸‹ä¸Šå‚³ CSV æŒ‰éˆ•ï¼Œæœƒè·³å‡ºä¸€å€‹å°é é¢ -->
    <div class="modal fade" id="CSVModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content shadow">
                <!-- (æ¨™é¡Œ) æœ€ä¸Šæ–¹çš„å€åŸŸ -->
                <div class="modal-header bg-primary text-white">
                    <!-- æ¨™é¡Œ -->
                    <h5 class="modal-title">ä¸Šå‚³ CSV æª”æ¡ˆ</h5>
                    <!-- (å‰å‰æŒ‰éˆ•) é—œé–‰é€™å€‹å°é é¢çš„æŒ‰éˆ• -->
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        id="btnCloseCSVModal"></button>
                </div>

                <!-- (å…§å®¹) ä¸­é–“çš„å€åŸŸ -->
                <div class="modal-body">
                    <!-- (é¸æ“‡æ¡†) ä½¿ç”¨è€…é¸æ“‡çš„æ©Ÿå° -->
                    <div class="mb-3">
                        <!-- (æ¨™é¡Œ) èªªæ˜é¸æ“‡æ¡†çš„æ„ç¾© -->
                        <label class="form-label">é¸æ“‡è¦ä¸Šå‚³çš„æ©Ÿå°ï¼š</label>
                        <!-- é¸æ“‡æ¡† -->
                        <select class="form-select" id="selectCSVMachineID">
                            <option value=''></option>
                        </select>
                    </div>

                    <!-- (é¸æ“‡æŒ‰éˆ•) ä½¿ç”¨è€…é¸æ“‡çš„è¦ä¸Šå‚³çš„æª”æ¡ˆ -->
                    <div class="mb-3">
                        <!-- (æ¨™é¡Œ) èªªæ˜é¸æ“‡æ¡†çš„æ„ç¾© -->
                        <label class="form-label">é¸æ“‡è¦ä¸Šå‚³çš„ã€€CSVã€€æª”æ¡ˆï¼š</label>
                        <!-- é¸æ“‡æ¡† (åªå…è¨±ä¸Šå‚³csvæª”æ¡ˆ) -->
                        <input type="file" class="form-control" id="inputCSVFile" accept=".csv">
                    </div>
                </div>

                <!-- (æŒ‰éˆ•) æœ€ä¸‹æ–¹å€åŸŸ -->
                <div class="modal-footer">
                    <!-- (ç¢ºèªæŒ‰éˆ•) ç¢ºå®šè¦ä¸Šå‚³æª”æ¡ˆ -->
                    <button type="button" class="btn btn-primary" onclick="btnUploadCSVFile()">ä¸Šå‚³</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æœ€åº•ä¸‹çš„é»‘ç·š -->
    <footer class="text-center">
        <p class="mb-0">ç‰ˆæ¬Šæ‰€æœ‰ - 2025 æ™ºæ…§è£½é€ èª²ç¨‹</p>
    </footer>

    </div>
    </div>
    </div>
</body>

</html>